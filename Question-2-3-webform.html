<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Accessible Feedback Form</title>
        <meta charset="utf-8">
        <style>
            .control, fieldset {
                margin: 6px 0;
            }
            label {
                display: inline-block;
                width: 120px;
                vertical-align: top;
            }
            input + label {
                width: auto;
            }
            .error, .required {
                color: red;
            }
            fieldset ul {
                margin: 0;
            }
            /* Added screen-reader-only class
            */
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                border: 0;
            }
        </style>
    </head>
    <body>
        <h1>Feedback form</h1>
        /* Added aria-live region for success messages
        */  
        <div id="success-message" aria-live="polite" class="sr-only"></div>
        <form>
            /* Question 2 Fixes 
             Added proper label association and required indication 
            */
            <div class="control">
                <label for="name">Full name 
                    <span class="required" aria-hidden="true">*</span>
                    <span class="sr-only">(required)</span>
                </label>
                <input id="name" name="name" type="text" aria-required="true" required />
            </div>

            // Added aria-describedby for inline instructions 
            <div class="control">
                <label for="biography">Biography</label>
                <textarea id="biography" name="biography" aria-describedby="biography-hint"></textarea>
                <span id="biography-hint" class="instruction">Include examples on your skills in JavaScript.</span>
            </div>

            // Replaced div group with proper fieldset/legend 
            <fieldset>
                <legend>Gender</legend>
                <div class="control">
                    <input id="gender_male" name="gender" type="radio" value="male" />
                    <label for="gender_male">Male</label>
                </div>
                <div class="control">
                    <input id="gender_female" name="gender" type="radio" value="female" />
                    <label for="gender_female">Female</label>
                </div>
            </fieldset>

            // Added proper label association for checkbox 
            <div class="control">
                <input id="accept_agbs" name="accept_agbs" type="checkbox" value="1" />
                <label for="accept_agbs">I accept the terms and conditions</label>
            </div>

            <div class="control">
                <input name="validate" type="hidden" value="1" />
                <input type="submit" value="Register" />
            </div>
        </form>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            "use strict";
            (function() {
                var validateInput;

                // Question 3 Fixes
                function showSuccessMessage() {
                    const msg = 'All inputs are valid';
                    $('#success-message').text(msg).removeClass('sr-only');
                    setTimeout(() => $('#success-message').addClass('sr-only'), 2000);
                }

                $.urlParam = function(name) {
                    const results = new RegExp(`[?&]${name}=([^&#]*)`).exec(window.location.href);
                    return results ? decodeURI(results[1]) : null;
                };

                validateInput = function(input, message) {
                    const $input = $(`[name="${input}"]`);
                    const value = $.urlParam(input);

                    if (value === null) {
                        let $errorContainer = $('fieldset.errors');
                        if (!$errorContainer.length) {
                            $errorContainer = $(
                                '<fieldset class="errors" tabindex="-1">' +
                                '<legend>Errors</legend><ul></ul></fieldset>'
                            ).prependTo('form');
                        }

                        const $referencedElement = $input.is(':radio') 
                            ? $input.closest('fieldset') 
                            : $input;

                        // Fixed error link creation (R.G. hint fix)
                        const $error = $(
                            `<a class="error" href="#${$referencedElement.attr('id')}" ` +
                            `aria-describedby="${input}-error">${message}</a>`
                        ).click(function(e) {
                            $referencedElement.focus();
                            e.preventDefault();
                        });

                        $errorContainer.find('ul').append($('<li>').append($error));
                        $input.attr('aria-invalid', 'true');
                    }
                };

                $(document).ready(function() {
                    if ($.urlParam('validate')) {
                        validateInput('name', 'Please enter your name!');
                        validateInput('biography', 'Please tell us something about your history!');
                        validateInput('gender', 'Please tell us your gender!');
                        validateInput('accept_agbs', 'You must accept our terms and conditions!');

                        const $errors = $('.error');
                        if ($errors.length === 0) {
                            showSuccessMessage();
                        } else {
                            // Focus management for errors
                            $('fieldset.errors').focus();
                        }
                    }
                });
            })();
        </script>
    </body>
</html>
